<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>CTF</title>
    <style>body { margin: 0; }</style>
    <script src="//unpkg.com/d3"></script>
    <script src="//unpkg.com/globe.gl"></script>
  </head>
  <body>
    <div id="globeViz"></div>
    <script>
      const colorScale = d3.scaleSequentialSqrt(d3.interpolateYlOrRd);
      const getVal = feat => feat.properties.GDP_MD_EST / Math.max(1e5, feat.properties.POP_EST);

      fetch('assets/map.geojson').then(res => res.json()).then(countries => {
        const maxVal = Math.max(...countries.features.map(getVal));
        colorScale.domain([0, maxVal]);

        var world = Globe()
          .globeImageUrl('//unpkg.com/three-globe/example/img/earth-dark.jpg')
          .backgroundImageUrl('//unpkg.com/three-globe/example/img/night-sky.png')
          .polygonsData(countries.features.filter(d => d.properties.ISO_A2 !== 'AQ'))
          .polygonAltitude(0.02)
          .polygonCapColor('rgb(22, 22, 22)')
          .polygonSideColor(() => 'rgb(93, 52, 179)')
          .polygonStrokeColor(() => '#5D34B3')
          .onPolygonHover(hoverD => world
          .polygonAltitude(d => d === hoverD ? 0.04 : 0.02)
          .polygonCapColor(d => d === hoverD ? 'rgb(52, 24, 111)' : 'rgb(22, 22, 22)'))
          .polygonsTransitionDuration(300)
          .onPolygonClick(({ properties: d }) => {
            document.getElementById('challange_country').innerHTML = d.ADMIN;
            document.getElementById('challange_name').innerHTML = challanges[d.ISO_A2].name;
            document.getElementById('challange_description').innerHTML = challanges[d.ISO_A2].description;
            document.getElementById('challange_flag').action = challanges[d.ISO_A2].flag;
            document.getElementById('flag').value = challanges[d.ISO_A2].flag;
            document.getElementById('challange').style.display = 'grid';
            addEventListener('click', () => {
              if (event.target.id !== 'challange' && event.target.id !== 'challange_country' && event.target.id !== 'challange_name' && event.target.id !== 'challange_description' && event.target.id !== 'challange_flag' && event.target.id !== 'flag' && event.target.id !== 'submit')
                document.getElementById('challange').style.display = 'none';
            });
          })
          .polygonsTransitionDuration(300) 
        (document.getElementById('globeViz'))
        addEventListener('resize', () => location.reload());
      });
    </script>
    <script>
      let announcements = [];
      let challanges = [];
      let leaderboard = [];

      function getTimer() {
        fetch('/timedstart')
            .then(res => res.json())
            .then(data => {
                const endtime = data.stoptime;
                var now = new Date().getTime();
                var nowString = now.toString();
                nowString = nowString.substring(0, nowString.length - 3);
                now = parseInt(nowString);
                const distance = endtime - now;
                var days = Math.floor(distance / 60 / 60 / 24);
                var hours = Math.floor((distance % (60 * 60 * 24)) / (60 * 60));
                var minutes = Math.floor((distance % (60 * 60)) / (60));
                var seconds = Math.floor((distance % (60)));
                if (seconds < 0 || minutes < 0 || hours < 0 || days < 0) {
                    days = "0";
                    hours = "0";
                    minutes = "0";
                    seconds = "0";
                }
                document.getElementById('countDown').innerHTML = days + "d " + hours + "h " + minutes + "m " + seconds + "s ";

            })
      };

      function getAnnouncments() {
        fetch('/announcement')
            .then(res => res.json())
            .then(data => {
                announcements = data.announcements;
                console.log(announcements);
                const myNode = document.getElementById('announcments');
                while (myNode.firstChild) {
                  myNode.removeChild(myNode.firstChild);
                }
                for (i = 0; i < announcements.length; i++) {
                  //make h1 for every team
                  const announcement = document.createElement('p');
                  announcement.innerHTML = "MESSAGE: " + announcements[i].message;
                  document.getElementById('announcments').appendChild(announcement);

                }
            })
      }
      function getChallanges() {
        fetch('/challenges')
            .then(res => res.json())
            .then(data => {
                challanges = data;
            })
      }
      function getLeaderboard() {
        fetch('/points')
            .then(res => res.json())
            .then(data => {
                leaderboard = data.allpoints;
                //remove all children
                const myNode = document.getElementById('leaderboard');
                while (myNode.firstChild) {
                  myNode.removeChild(myNode.firstChild);
                }
                for (i = 0; i < leaderboard.length; i++) {
                  //make h1 for every team
                  const team = document.createElement('p');
                  team.innerHTML = leaderboard[i].team + ": " + leaderboard[i].points;
                  document.getElementById('leaderboard').appendChild(team);

                }
            })
      }
      function updater() {
        getTimer();
        getAnnouncments();
        getChallanges();
        getLeaderboard();
        setTimeout(updater, 1000);
      }
    updater();

    function assingnChallangeToCountry(challange) {

    }
    </script>
    <div id="countDown">
      <h1></h1>
    </div>
    <p id="leaderHead">LEADERBOARD: </p>
    <div id="leaderboard">
    </div>
    <p id="announcmentsHead">ANNOUNCMENTS: </p>
    <div id="announcments">
    </div>
    <div id="challange">
      <p id="challange_name">Challange Name</p>
      <p id="challange_country"></p>
      <p id="challange_description">Challange Description</p>
      <form id="challange_flag" method="post">
        <input type="text" id="flag" placeholder="Flag" />
        <input type="submit" value="Submit" />
      </form>
    </div>
  </body>
  <style>
    body {
      overflow: hidden;
    }
    #announcmentsHead {
        position: absolute;
        top: 0;
        left: 0;
        color: #fff;
        opacity: 0.9;
        padding: 20px;
        font-family: sans-serif;
        font-size: 1em;
    }
    #announcments {
      position: absolute;
      top: 60px;
      left: 10px;
      width: 250px;
      color: #fff;
      background: rgb(10, 10, 10);
      opacity: 0.9;
      padding: 20px;
      font-family: monospace;
      font-size: 1em;
      border-radius: 10px;
      border:#5D34B3;
      border-style: solid;
    }
    #leaderHead {
        position: absolute;
        top: 0;
        right: 60px;
        color: #fff;
        opacity: 0.9;
        padding: 20px;
        font-family: sans-serif;
        font-size: 1em;
    }
    #leaderboard {
      position: absolute;
      top: 60px;
      right: 10px;
      width: 150px;
      color: #fff;
      background: rgb(10, 10, 10);
      opacity: 0.9;
      padding: 20px;
      font-family: monospace;
      font-size: 1em;
      border-radius: 10px;
      border:#5D34B3;
      border-style: solid;
    }
    #announcment {
      position: absolute;
      top: 0;
      left: 0;
      width: 20%;
      height: 100%;
      color: #fff;
      background: rgb(10, 10, 10);
      opacity: 0.9;
      padding: 20px;
      font-family: sans-serif;
      font-size: 1.5em;
    }
    #countDown {
      /* center it horizontally */
      font-family: monospace;
      font-weight: lighter;
      font-size: 3em;
      position: absolute;
      top: 10px;
      bottom: 0;
      width: 100%;
      height: 100px;
      text-align: center;
      color:#fff;
    }
    #challange {
      position: absolute;
      display: none;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-family: sans-serif;
      font-size: 2em;
      color: #fff;
      background: rgb(10, 10, 10);
      width: 600px;
      height: 300px;
      border-radius: 10px;
      padding: 20px;
      border: 2px solid rgb(93, 52, 179);
      opacity: 0.9; 
    }
    #challange_name {
      font-family: monospace;
      font-weight: normal;
      font-size: 1.5em;
      height: 50px;
    }
    #challange_country {
      font-family: monospace;
      font-weight: lighter;
      color: rgb(121, 121, 121);
      font-size: 1em;
    }
    #challange_description {
      font-family: monospace;
      font-weight: lighter;
      font-size: 0.5em;
    }
  </style>
</html>